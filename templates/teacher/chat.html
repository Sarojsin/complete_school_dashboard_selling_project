<!-- templates/teacher/chat.html -->
{% extends 'base.html' %}

{% block title %}Teacher Chat{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-3">
            <!-- Sidebar -->
            {% include 'teacher/sidebar.html' %}
        </div>
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Communications</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newMessageModal">
                    <i class="bi bi-pencil-square me-2"></i> New Message
                </button>
            </div>

            <div class="row">
                <!-- Contacts Sidebar -->
                <div class="col-md-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-light">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control border-start-0" placeholder="Search contacts..."
                                    id="contactSearch">
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush" id="contactsList" style="height: 500px; overflow-y: auto;">
                                <!-- Students -->
                                {% if students %}
                                <div class="list-group-item bg-light sticky-top">
                                    <small class="text-muted fw-bold">STUDENTS</small>
                                </div>
                                {% for student in students %}
                                <a href="#" class="list-group-item list-group-item-action contact-item"
                                    data-id="{{ student.id }}" data-type="student" data-name="{{ student.name }}">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center text-white me-3"
                                            style="width: 40px; height: 40px;">
                                            {{ student.name|first }}
                                        </div>
                                        <div class="flex-grow-1 overflow-hidden">
                                            <h6 class="mb-0 text-truncate">{{ student.name }}</h6>
                                            <small class="text-muted d-block text-truncate">{{ student.grade }}  {{
                                                student.section }}</small>
                                        </div>
                                        {% if student.unread_count > 0 %}
                                        <span class="badge bg-danger rounded-pill ms-auto">{{ student.unread_count
                                            }}</span>
                                        {% endif %}
                                    </div>
                                </a>
                                {% endfor %}
                                {% endif %}

                                <!-- Parents -->
                                {% if parents %}
                                <div class="list-group-item bg-light sticky-top mt-2">
                                    <small class="text-muted fw-bold">PARENTS</small>
                                </div>
                                {% for parent in parents %}
                                <a href="#" class="list-group-item list-group-item-action contact-item"
                                    data-id="{{ parent.id }}" data-type="parent" data-name="{{ parent.student_name }}">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-info d-flex align-items-center justify-content-center text-white me-3"
                                            style="width: 40px; height: 40px;">
                                            {{ parent.student_name|first }}
                                        </div>
                                        <div class="flex-grow-1 overflow-hidden">
                                            <h6 class="mb-0 text-truncate">{{ parent.student_name }}</h6>
                                            <small class="text-muted d-block text-truncate">Parent: {{
                                                parent.name }}</small>
                                        </div>
                                        {% if parent.unread_count > 0 %}
                                        <span class="badge bg-danger rounded-pill ms-auto">{{ parent.unread_count
                                            }}</span>
                                        {% endif %}
                                    </div>
                                </a>
                                {% endfor %}
                                {% endif %}

                                <!-- Colleagues -->
                                {% if teachers %}
                                <div class="list-group-item bg-light sticky-top mt-2">
                                    <small class="text-muted fw-bold">COLLEAGUES</small>
                                </div>
                                {% for teacher in teachers %}
                                <a href="#" class="list-group-item list-group-item-action contact-item"
                                    data-id="{{ teacher.id }}" data-type="teacher" data-name="{{ teacher.name }}">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-success d-flex align-items-center justify-content-center text-white me-3"
                                            style="width: 40px; height: 40px;">
                                            {{ teacher.name|first }}
                                        </div>
                                        <div class="flex-grow-1 overflow-hidden">
                                            <h6 class="mb-0 text-truncate">{{ teacher.name }}</h6>
                                            <small class="text-muted d-block text-truncate">{{ teacher.department
                                                }}</small>
                                        </div>
                                        {% if teacher.unread_count > 0 %}
                                        <span class="badge bg-danger rounded-pill ms-auto">{{ teacher.unread_count
                                            }}</span>
                                        {% endif %}
                                    </div>
                                </a>
                                {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="col-md-8">
                    <div class="card shadow-sm h-100">
                        <div
                            class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <div id="currentChatInfo">
                                <h5 class="mb-0">Select a contact to start chatting</h5>
                            </div>
                            <div class="dropdown" id="chatActions" style="display: none;">
                                <button class="btn btn-light btn-sm dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item text-danger" href="#" id="clearChatBtn"><i
                                                class="bi bi-trash me-2"></i>Clear Chat</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body p-0 d-flex flex-column" style="height: 500px;">
                            <!-- Chat Messages -->
                            <div class="chat-messages p-3 flex-grow-1" id="chatMessages" style="overflow-y: auto;">
                                <div class="text-center text-muted py-5 mt-5">
                                    <i class="bi bi-chat-text display-1 mb-3"></i>
                                    <p class="lead">Select a contact to view messages</p>
                                    <small>Messages are automatically deleted after 24 hours.</small>
                                </div>
                            </div>

                            <!-- Message Input -->
                            <div class="card-footer bg-light" id="messageInput" style="display: none;">
                                <form id="messageForm">
                                    <div class="input-group">
                                        <input type="text" class="form-control" placeholder="Type your message..."
                                            id="messageText" required autocomplete="off">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-send-fill"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted mt-1 d-block">Messages expire in 24 hours.</small>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Message Modal -->
<div class="modal fade" id="newMessageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newMessageForm">
                    <div class="mb-3">
                        <label class="form-label">Recipient Type</label>
                        <select class="form-select" id="recipientType" required>
                            <option value="">Select Type</option>
                            <option value="student">Student</option>
                            <option value="parent">Parent</option>
                            <option value="teacher">Teacher</option>
                        </select>
                    </div>

                    <div class="mb-3" id="recipientSelection" style="display: none;">
                        <label class="form-label">Select Recipient</label>
                        <select class="form-select" id="recipientSelect" required>
                            <option value="">Select Recipient</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea class="form-control" id="newMessageText" rows="4"
                            placeholder="Type your message here..." required></textarea>
                    </div>

                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Message</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let currentChat = null;
        let socket = null;
        let currentUser = {{ current_user.id }};

        const contactsList = document.getElementById('contactsList');
        const currentChatInfo = document.getElementById('currentChatInfo');
        const chatActions = document.getElementById('chatActions');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const messageForm = document.getElementById('messageForm');
        const messageText = document.getElementById('messageText');
        const newMessageForm = document.getElementById('newMessageForm');
        const newMessageModal = new bootstrap.Modal(document.getElementById('newMessageModal'));

        // Initialize WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = ${protocol}///ws/;

            socket = new WebSocket(wsUrl);

            socket.onopen = function () {
                console.log('WebSocket connected');
            };

            socket.onmessage = function (event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            socket.onclose = function () {
                console.log('WebSocket disconnected. Reconnecting...');
                setTimeout(connectWebSocket, 3000);
            };
        }

        connectWebSocket();

        // Contact selection
        contactsList.addEventListener('click', function (e) {
            const contactItem = e.target.closest('.contact-item');
            if (contactItem) {
                e.preventDefault();
                selectContact(contactItem);
            }
        });

        function selectContact(element) {
            // Update UI
            document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            const userId = element.dataset.id;
            const userName = element.dataset.name;
            const userType = element.dataset.type;

            currentChat = {
                id: userId,
                name: userName,
                type: userType
            };

            // Update Header
            let typeLabel = 'Contact';
            if (userType === 'student') typeLabel = 'Student';
            else if (userType === 'parent') typeLabel = 'Parent';
            else if (userType === 'teacher') typeLabel = 'Colleague';

            currentChatInfo.innerHTML = 
            <div class="d-flex align-items-center">
                <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center text-white me-3" style="width: 40px; height: 40px;">
                    
                </div>
                <div>
                    <h5 class="mb-0"></h5>
                    <small class="text-white-50"></small>
                </div>
            </div>
        ;

            chatActions.style.display = 'block';
            messageInput.style.display = 'block';

            // Load Messages
            loadMessages(userId);

            // Mark as read
            markAsRead(userId);

            // Remove badge
            const badge = element.querySelector('.badge');
            if (badge) badge.remove();
        }

        function loadMessages(userId) {
            chatMessages.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>';

            fetch(/api/chat/messages/)
                .then(response => response.json())
                .then(data => {
                    chatMessages.innerHTML = '';
                    if (data.messages.length === 0) {
                        chatMessages.innerHTML = '<div class="text-center text-muted py-5"><p>No messages yet. Start the conversation!</p></div>';
                    } else {
                        const messages = data.messages.reverse();
                        messages.forEach(msg => appendMessage(msg));
                        scrollToBottom();
                    }
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    chatMessages.innerHTML = '<div class="text-center text-danger py-5"><p>Error loading messages.</p></div>';
                });
        }

        function appendMessage(msg) {
            const isMe = msg.sender_id === currentUser;
            const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const div = document.createElement('div');
            div.className = d-flex mb-3 ;

            div.innerHTML = 
            <div class="card border-0 shadow-sm " style="max-width: 75%; border-radius: 15px; ">
                <div class="card-body p-2 px-3">
                    <p class="mb-1"></p>
                    <div class="d-flex align-items-center justify-content-end">
                        <small class="" style="font-size: 0.7rem;"></small>
                        
                    </div>
                </div>
            </div>
        ;

            chatMessages.appendChild(div);
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send Message
        messageForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const content = messageText.value.trim();
            if (!content || !currentChat) return;

            sendMessage(currentChat.id, content);
            messageText.value = '';
        });

        // New Message Modal Logic
        const recipientType = document.getElementById('recipientType');
        const recipientSelection = document.getElementById('recipientSelection');
        const recipientSelect = document.getElementById('recipientSelect');

        recipientType.addEventListener('change', function () {
            const type = this.value;
            recipientSelect.innerHTML = '<option value="">Select Recipient</option>';

            if (type) {
                recipientSelection.style.display = 'block';
                
                // Populate based on server-rendered data available in JS?
                // We can't easily access the Jinja lists here without serializing them.
                // Or we can just parse the DOM elements.
                
                let selector = '';
                if (type === 'student') selector = '.contact-item[data-type="student"]';
                else if (type === 'parent') selector = '.contact-item[data-type="parent"]';
                else if (type === 'teacher') selector = '.contact-item[data-type="teacher"]';
                
                const items = document.querySelectorAll(selector);
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.dataset.id;
                    option.textContent = item.dataset.name;
                    recipientSelect.appendChild(option);
                });
            } else {
                recipientSelection.style.display = 'none';
            }
        });

        newMessageForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const recipientId = recipientSelect.value;
            const content = document.getElementById('newMessageText').value.trim();

            if (!recipientId || !content) return;

            sendMessage(recipientId, content);
            newMessageModal.hide();
            document.getElementById('newMessageText').value = '';

            // Select the contact
            const contactItem = document.querySelector(.contact-item[data-id=""]);
            if (contactItem) {
                contactItem.click();
            }
        });

        function sendMessage(receiverId, content) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    receiver_id: parseInt(receiverId),
                    content: content
                }));

                appendMessage({
                    sender_id: currentUser,
                    content: content,
                    created_at: new Date().toISOString(),
                    is_read: false
                });
                scrollToBottom();
            } else {
                alert('Connection lost. Please refresh the page.');
            }
        }

        function handleWebSocketMessage(data) {
            if (currentChat && (data.sender_id == currentChat.id || data.receiver_id == currentChat.id)) {
                if (data.sender_id != currentUser) {
                    appendMessage(data);
                    scrollToBottom();
                    markAsRead(currentChat.id);
                }
            } else {
                // Find contact item and show badge
                const contactItem = document.querySelector(.contact-item[data-id=""]);
                if (contactItem) {
                    let badge = contactItem.querySelector('.badge');
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'badge bg-danger rounded-pill ms-auto';
                        badge.textContent = '0';
                        contactItem.querySelector('.d-flex').appendChild(badge);
                    }
                    badge.textContent = parseInt(badge.textContent) + 1;
                }
            }
        }

        function markAsRead(senderId) {
            fetch(/api/chat/mark-read/, { method: 'POST' });
        }

        // Search functionality
        document.getElementById('contactSearch').addEventListener('input', function (e) {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.contact-item').forEach(item => {
                const name = item.dataset.name.toLowerCase();
                if (name.includes(term)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    });
</script>
{% endblock %}
