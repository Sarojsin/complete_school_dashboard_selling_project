{% extends "base.html" %}

{% block title %}Take Attendance{% endblock %}

{% block sidebar_content %}
<ul class="nav flex-column">
    <li class="nav-item">
        <a class="nav-link" href="/teacher/dashboard">
            <i class="bi bi-speedometer2 me-2"></i>Dashboard
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="/teacher/attendance">
            <i class="bi bi-calendar-check me-2"></i>Attendance
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link active" href="/teacher/take-attendance">
            <i class="bi bi-clipboard-check me-2"></i>Take Attendance
        </a>
    </li>
</ul>
{% endblock %}

{% block page_title %}Take Attendance{% endblock %}

{% block page_actions %}
<div class="dropdown">
    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-filter me-1"></i>Quick Actions
    </button>
    <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#" id="markAllPresent">Mark All Present</a></li>
        <li><a class="dropdown-item" href="#" id="markAllAbsent">Mark All Absent</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="#" id="saveDraft">Save Draft</a></li>
    </ul>
</div>
{% endblock %}

{% block content %}
<!-- Class Information -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="card-title mb-2">{{ class_info.course_name }}</h4>
                        <div class="row">
                            <div class="col-md-4">
                                <small class="text-muted d-block">Class</small>
                                <strong>{{ class_info.grade }}{{ class_info.section }}</strong>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted d-block">Period</small>
                                <strong>{{ class_info.period }} ({{ class_info.time }})</strong>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted d-block">Room</small>
                                <strong>{{ class_info.room }}</strong>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="attendance-stats">
                            <div class="d-flex justify-content-around text-center">
                                <div>
                                    <div class="h4 mb-0 text-success" id="presentCount">0</div>
                                    <small class="text-muted">Present</small>
                                </div>
                                <div>
                                    <div class="h4 mb-0 text-danger" id="absentCount">0</div>
                                    <small class="text-muted">Absent</small>
                                </div>
                                <div>
                                    <div class="h4 mb-0 text-warning" id="lateCount">0</div>
                                    <small class="text-muted">Late</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Form -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clipboard-data me-2"></i>Student Attendance
                    </h5>
                    <div class="d-flex align-items-center">
                        <span class="me-3">
                            <strong>Date:</strong> {{ today_date }}
                        </span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoSave" checked>
                            <label class="form-check-label" for="autoSave">Auto-save</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form id="attendanceForm" method="POST" action="/teacher/attendance/save">
                    <input type="hidden" name="class_id" value="{{ class_info.id }}">
                    <input type="hidden" name="attendance_date" value="{{ today_date }}">
                    
                    <!-- Quick Action Buttons -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-success" data-action="present">
                                    <i class="bi bi-check-circle"></i> Mark Present
                                </button>
                                <button type="button" class="btn btn-outline-danger" data-action="absent">
                                    <i class="bi bi-x-circle"></i> Mark Absent
                                </button>
                                <button type="button" class="btn btn-outline-warning" data-action="late">
                                    <i class="bi bi-clock"></i> Mark Late
                                </button>
                                <button type="button" class="btn btn-outline-info" data-action="halfday">
                                    <i class="bi bi-record-circle"></i> Half Day
                                </button>
                            </div>
                            <div class="btn-group btn-group-sm ms-2" role="group">
                                <button type="button" class="btn btn-outline-secondary" id="clearAll">
                                    <i class="bi bi-arrow-clockwise"></i> Clear All
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Students List -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="attendanceTable">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Student</th>
                                    <th style="width: 120px;">Roll No</th>
                                    <th style="width: 200px;">Status</th>
                                    <th style="width: 150px;">Arrival Time</th>
                                    <th style="width: 200px;">Remarks</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in students %}
                                <tr class="attendance-row" data-student-id="{{ student.id }}">
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="{{ student.avatar }}" class="rounded-circle me-3" width="40" height="40" alt="{{ student.name }}">
                                            <div>
                                                <h6 class="mb-1">{{ student.name }}</h6>
                                                <small class="text-muted">{{ student.email }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>{{ student.roll_number }}</strong>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <input type="radio" class="btn-check" name="attendance[{{ student.id }}]" value="present" id="present{{ student.id }}" autocomplete="off">
                                            <label class="btn btn-outline-success" for="present{{ student.id }}">
                                                <i class="bi bi-check-lg"></i>
                                            </label>

                                            <input type="radio" class="btn-check" name="attendance[{{ student.id }}]" value="absent" id="absent{{ student.id }}" autocomplete="off">
                                            <label class="btn btn-outline-danger" for="absent{{ student.id }}">
                                                <i class="bi bi-x-lg"></i>
                                            </label>

                                            <input type="radio" class="btn-check" name="attendance[{{ student.id }}]" value="late" id="late{{ student.id }}" autocomplete="off">
                                            <label class="btn btn-outline-warning" for="late{{ student.id }}">
                                                <i class="bi bi-clock"></i>
                                            </label>

                                            <input type="radio" class="btn-check" name="attendance[{{ student.id }}]" value="half_day" id="halfday{{ student.id }}" autocomplete="off">
                                            <label class="btn btn-outline-info" for="halfday{{ student.id }}">
                                                <i class="bi bi-record-circle"></i>
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="time" class="form-control form-control-sm arrival-time" name="arrival_time[{{ student.id }}]" disabled>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control form-control-sm" name="remarks[{{ student.id }}]" placeholder="Add remarks...">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary and Actions -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Attendance Summary</h6>
                                    <div class="row text-center">
                                        <div class="col-3">
                                            <div class="h5 mb-0 text-success" id="summaryPresent">0</div>
                                            <small>Present</small>
                                        </div>
                                        <div class="col-3">
                                            <div class="h5 mb-0 text-danger" id="summaryAbsent">0</div>
                                            <small>Absent</small>
                                        </div>
                                        <div class="col-3">
                                            <div class="h5 mb-0 text-warning" id="summaryLate">0</div>
                                            <small>Late</small>
                                        </div>
                                        <div class="col-3">
                                            <div class="h5 mb-0 text-info" id="summaryHalfday">0</div>
                                            <small>Half Day</small>
                                        </div>
                                    </div>
                                    <div class="progress mt-2" style="height: 8px;">
                                        <div class="progress-bar bg-success" style="width: 0%" id="progressPresent"></div>
                                        <div class="progress-bar bg-danger" style="width: 0%" id="progressAbsent"></div>
                                        <div class="progress-bar bg-warning" style="width: 0%" id="progressLate"></div>
                                        <div class="progress-bar bg-info" style="width: 0%" id="progressHalfday"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-end gap-2 h-100 align-items-center">
                                <button type="button" class="btn btn-outline-secondary" id="saveDraftBtn">
                                    <i class="bi bi-file-earmark me-1"></i>Save Draft
                                </button>
                                <button type="submit" class="btn btn-primary" id="submitAttendance">
                                    <i class="bi bi-check-circle me-1"></i>Submit Attendance
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Recent Attendance History -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock-history me-2"></i>Recent Attendance for This Class
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Present</th>
                                <th>Absent</th>
                                <th>Late</th>
                                <th>Attendance %</th>
                                <th>Taken By</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in recent_attendance %}
                            <tr>
                                <td>{{ record.date }}</td>
                                <td class="text-success">{{ record.present }}</td>
                                <td class="text-danger">{{ record.absent }}</td>
                                <td class="text-warning">{{ record.late }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 6px; width: 80px;">
                                            <div class="progress-bar bg-{{ 'success' if record.percentage >= 85 else 'warning' if record.percentage >= 75 else 'danger' }}" 
                                                 style="width: {{ record.percentage }}%"></div>
                                        </div>
                                        <small>{{ record.percentage }}%</small>
                                    </div>
                                </td>
                                <td>{{ record.teacher }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Attendance -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0">
                    <i class="bi bi-qr-code me-2"></i>QR Code Attendance
                </h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <p class="text-muted">
                            Students can scan this QR code to mark their own attendance. 
                            The QR code will expire in <strong id="qrTimer">15:00</strong> minutes.
                        </p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" id="generateQR">
                                <i class="bi bi-qr-code me-1"></i>Generate New QR
                            </button>
                            <button class="btn btn-outline-success" id="startQR">
                                <i class="bi bi-play-circle me-1"></i>Start QR Session
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-center">
                        <div id="qrCodeContainer" class="border rounded p-3 bg-light">
                            <p class="text-muted mb-3">QR Code will appear here</p>
                            <div class="spinner-border text-primary" role="status" id="qrSpinner">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Attendance counters
    let presentCount = 0;
    let absentCount = 0;
    let lateCount = 0;
    let halfdayCount = 0;
    const totalStudents = {{ students|length }};

    // Update counters
    function updateCounters() {
        presentCount = document.querySelectorAll('input[value="present"]:checked').length;
        absentCount = document.querySelectorAll('input[value="absent"]:checked').length;
        lateCount = document.querySelectorAll('input[value="late"]:checked').length;
        halfdayCount = document.querySelectorAll('input[value="half_day"]:checked').length;

        // Update display counters
        document.getElementById('presentCount').textContent = presentCount;
        document.getElementById('absentCount').textContent = absentCount;
        document.getElementById('lateCount').textContent = lateCount;
        
        document.getElementById('summaryPresent').textContent = presentCount;
        document.getElementById('summaryAbsent').textContent = absentCount;
        document.getElementById('summaryLate').textContent = lateCount;
        document.getElementById('summaryHalfday').textContent = halfdayCount;

        // Update progress bars
        const presentPercent = (presentCount / totalStudents) * 100;
        const absentPercent = (absentCount / totalStudents) * 100;
        const latePercent = (lateCount / totalStudents) * 100;
        const halfdayPercent = (halfdayCount / totalStudents) * 100;

        document.getElementById('progressPresent').style.width = presentPercent + '%';
        document.getElementById('progressAbsent').style.width = absentPercent + '%';
        document.getElementById('progressLate').style.width = latePercent + '%';
        document.getElementById('progressHalfday').style.width = halfdayPercent + '%';
    }

    // Quick action buttons
    document.querySelectorAll('[data-action]').forEach(button => {
        button.addEventListener('click', function() {
            const action = this.getAttribute('data-action');
            document.querySelectorAll('.attendance-row').forEach(row => {
                const studentId = row.getAttribute('data-student-id');
                const radio = document.querySelector(`input[name="attendance[${studentId}]"][value="${action}"]`);
                if (radio) {
                    radio.checked = true;
                    radio.dispatchEvent(new Event('change'));
                }
            });
        });
    });

    // Mark all present/absent
    document.getElementById('markAllPresent').addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('input[value="present"]').forEach(radio => {
            radio.checked = true;
            radio.dispatchEvent(new Event('change'));
        });
    });

    document.getElementById('markAllAbsent').addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('input[value="absent"]').forEach(radio => {
            radio.checked = true;
            radio.dispatchEvent(new Event('change'));
        });
    });

    // Clear all
    document.getElementById('clearAll').addEventListener('click', function() {
        document.querySelectorAll('.btn-check').forEach(radio => {
            radio.checked = false;
        });
        document.querySelectorAll('.arrival-time').forEach(input => {
            input.value = '';
            input.disabled = true;
        });
        updateCounters();
    });

    // Enable/disable arrival time based on status
    document.querySelectorAll('.btn-check').forEach(radio => {
        radio.addEventListener('change', function() {
            const studentId = this.name.match(/\[(.*?)\]/)[1];
            const arrivalTime = document.querySelector(`input[name="arrival_time[${studentId}]"]`);
            
            if (this.value === 'late') {
                arrivalTime.disabled = false;
                arrivalTime.value = new Date().toTimeString().substring(0, 5);
            } else {
                arrivalTime.disabled = true;
                arrivalTime.value = '';
            }
            
            updateCounters();
            
            // Auto-save if enabled
            if (document.getElementById('autoSave').checked) {
                saveDraft();
            }
        });
    });

    // Save draft
    function saveDraft() {
        const formData = new FormData(document.getElementById('attendanceForm'));
        // Send AJAX request to save draft
        console.log('Saving draft...', formData);
        
        // Show success feedback
        const toast = document.createElement('div');
        toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed bottom-0 end-0 m-3';
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check-circle me-2"></i>Draft saved successfully
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        document.body.appendChild(toast);
        new bootstrap.Toast(toast).show();
        
        setTimeout(() => toast.remove(), 3000);
    }

    document.getElementById('saveDraftBtn').addEventListener('click', saveDraft);

    // QR Code functionality
    document.getElementById('generateQR').addEventListener('click', function() {
        const spinner = document.getElementById('qrSpinner');
        const container = document.getElementById('qrCodeContainer');
        
        spinner.style.display = 'block';
        container.innerHTML = '<p class="text-muted mb-3">QR Code will appear here</p>';
        container.appendChild(spinner);
        
        // Simulate QR generation
        setTimeout(() => {
            spinner.style.display = 'none';
            container.innerHTML = `
                <img src="https://via.placeholder.com/200x200?text=QR+Code" alt="Attendance QR Code" class="img-fluid mb-2">
                <p class="small text-muted">Class: {{ class_info.course_name }}</p>
                <p class="small text-muted">Expires in: <span id="qrTimer">15:00</span></p>
            `;
            startQRTimer(15 * 60); // 15 minutes
        }, 1000);
    });

    function startQRTimer(duration) {
        let timer = duration;
        const display = document.getElementById('qrTimer');
        
        const interval = setInterval(() => {
            const minutes = Math.floor(timer / 60);
            const seconds = timer % 60;
            
            display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (--timer < 0) {
                clearInterval(interval);
                display.textContent = "Expired";
                document.getElementById('qrCodeContainer').innerHTML = '<p class="text-muted">QR Code expired</p>';
            }
        }, 1000);
    }

    // Initialize counters
    updateCounters();
</script>
{% endblock %}