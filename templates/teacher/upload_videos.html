<!-- templates/teacher/upload_videos.html -->
{% extends 'base.html' %}

{% block title %}Upload Videos{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-3">
            <!-- Sidebar -->
            {% include 'teacher/sidebar.html' %}
        </div>
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Upload Learning Videos</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="fas fa-upload me-2"></i> Upload Video
                </button>
            </div>

            <!-- Upload Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Videos</h6>
                                    <h3>{{ stats.total_videos }}</h3>
                                </div>
                                <i class="fas fa-video fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Size</h6>
                                    <h3>{{ stats.total_size }} GB</h3>
                                </div>
                                <i class="fas fa-hdd fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Views</h6>
                                    <h3>{{ stats.total_views }}</h3>
                                </div>
                                <i class="fas fa-eye fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">This Month</h6>
                                    <h3>{{ stats.this_month }}</h3>
                                </div>
                                <i class="fas fa-calendar fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Uploads -->
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Uploads</h5>
                    <div class="dropdown">
                        <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" 
                                data-bs-toggle="dropdown">
                            <i class="fas fa-filter me-1"></i> Filter
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="?filter=all">All Videos</a></li>
                            <li><a class="dropdown-item" href="?filter=recent">Recent</a></li>
                            <li><a class="dropdown-item" href="?filter=popular">Most Viewed</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Video</th>
                                    <th>Subject</th>
                                    <th>Class</th>
                                    <th>Upload Date</th>
                                    <th>Size</th>
                                    <th>Views</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for video in videos %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="{{ video.thumbnail }}" class="rounded me-3" 
                                                 width="60" height="40" alt="Thumbnail">
                                            <div>
                                                <strong>{{ video.title }}</strong>
                                                <br>
                                                <small class="text-muted">{{ video.duration }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ video.subject }}</td>
                                    <td>{{ video.class }}</td>
                                    <td>{{ video.upload_date }}</td>
                                    <td>{{ video.size }}</td>
                                    <td>
                                        <span class="badge bg-light text-dark">
                                            <i class="fas fa-eye me-1"></i>{{ video.views }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if video.status == 'processed' else 'warning' if video.status == 'processing' else 'secondary' }}">
                                            {{ video.status|title }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary view-video" 
                                                    data-id="{{ video.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-info edit-video" 
                                                    data-id="{{ video.id }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger delete-video" 
                                                    data-id="{{ video.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if not videos %}
                    <div class="text-center py-5">
                        <i class="fas fa-video fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Videos Uploaded</h5>
                        <p class="text-muted">Upload your first educational video to get started.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            <i class="fas fa-upload me-2"></i> Upload Video
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Storage Usage -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Storage Usage</h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Used: {{ storage.used }} GB</span>
                                    <span>Total: {{ storage.total }} GB</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-{{ 'success' if storage.percentage < 70 else 'warning' if storage.percentage < 90 else 'danger' }}" 
                                         style="width: {{ storage.percentage }}%"></div>
                                </div>
                                <small class="text-muted">{{ storage.percentage }}% of storage used</small>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            {% if storage.percentage > 80 %}
                            <div class="alert alert-warning mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Storage almost full
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload New Video</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="POST" enctype="multipart/form-data" id="uploadForm">
                    <div class="mb-3">
                        <label class="form-label">Video File *</label>
                        <input type="file" class="form-control" name="video_file" 
                               accept="video/*" required id="videoFile">
                        <div class="form-text">Supported formats: MP4, MOV, AVI, WMV. Max 500MB.</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Title *</label>
                                <input type="text" class="form-control" name="title" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Subject *</label>
                                <select class="form-select" name="subject" required>
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject }}">{{ subject }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Class *</label>
                                <select class="form-select" name="class" required>
                                    <option value="">Select Class</option>
                                    {% for class in classes %}
                                    <option value="{{ class }}">{{ class }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Chapter/Topic</label>
                                <input type="text" class="form-control" name="chapter" 
                                       placeholder="e.g., Chapter 1: Introduction">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3" 
                                  placeholder="Brief description of the video content..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Tags</label>
                        <input type="text" class="form-control" name="tags" 
                               placeholder="Enter tags separated by commas">
                        <div class="form-text">e.g., algebra, equations, math-basics</div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_downloadable" id="is_downloadable">
                            <label class="form-check-label" for="is_downloadable">
                                Allow students to download this video
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="notify_students" id="notify_students" checked>
                            <label class="form-check-label" for="notify_students">
                                Notify students about new video
                            </label>
                        </div>
                    </div>

                    <!-- Upload Progress -->
                    <div class="mb-3" id="uploadProgress" style="display: none;">
                        <label class="form-label">Upload Progress</label>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="progressText">Preparing upload...</small>
                    </div>

                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="uploadButton">
                            <i class="fas fa-upload me-2"></i> Upload Video
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Video file size validation
    const videoFileInput = document.getElementById('videoFile');
    const uploadForm = document.getElementById('uploadForm');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = uploadProgress.querySelector('.progress-bar');
    const progressText = document.getElementById('progressText');
    const uploadButton = document.getElementById('uploadButton');

    videoFileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const maxSize = 500 * 1024 * 1024; // 500MB in bytes
            if (file.size > maxSize) {
                alert('File size must be less than 500MB');
                this.value = '';
            }
        }
    });

    // Upload progress simulation (in real app, this would be handled by backend)
    uploadForm.addEventListener('submit', function(e) {
        const fileInput = document.querySelector('input[name="video_file"]');
        if (fileInput.files.length === 0) {
            e.preventDefault();
            alert('Please select a video file');
            return;
        }

        uploadProgress.style.display = 'block';
        uploadButton.disabled = true;

        // Simulate upload progress
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 10;
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);
                progressText.textContent = 'Processing video...';
            } else {
                progressBar.style.width = progress + '%';
                progressText.textContent = `Uploading: ${Math.round(progress)}%`;
            }
        }, 200);
    });

    // Video actions
    document.querySelectorAll('.view-video').forEach(button => {
        button.addEventListener('click', function() {
            const videoId = this.getAttribute('data-id');
            window.open(`/teacher/videos/${videoId}`, '_blank');
        });
    });

    document.querySelectorAll('.edit-video').forEach(button => {
        button.addEventListener('click', function() {
            const videoId = this.getAttribute('data-id');
            // Implement edit functionality
            window.location.href = `/teacher/videos/${videoId}/edit`;
        });
    });

    document.querySelectorAll('.delete-video').forEach(button => {
        button.addEventListener('click', function() {
            const videoId = this.getAttribute('data-id');
            if (confirm('Are you sure you want to delete this video?')) {
                fetch(`/teacher/videos/${videoId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    }
                });
            }
        });
    });
});
</script>
{% endblock %}